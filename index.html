<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bitcoin Correlation Dashboard | Herdvibe</title>
<meta name="description" content="Bitcoin weekly chart with rolling correlation against SPY, QQQ, IGV, GLD, DXY">
<meta property="og:title" content="Bitcoin Correlation Dashboard">
<meta property="og:description" content="비트코인과 주요 자산 간 상관관계 분석">
<meta property="og:type" content="website">
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js" integrity="sha384-DKYJZ8NLiK8MN4/C5P2vDkVBLkWgJJeCi06ioih4sFIzjIoFcsaZMzVIWKKPYrk" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
::-webkit-scrollbar{display:none}
*{-ms-overflow-style:none;scrollbar-width:none}
:root{--bg-primary:#0a0a0a;--bg-secondary:#111111;--bg-tertiary:#1a1a1a;--text-primary:#ffffff;--text-secondary:#888888;--text-muted:#555555;--accent-green:#00d4aa;--accent-red:#ff4757;--accent-yellow:#ffd43b;--accent-blue:#4dabf7;--border-color:#2a2a2a;--color-spy:#4dabf7;--color-qqq:#b197fc;--color-igv:#00d4aa;--color-gld:#ffd43b;--color-dxy:#ff4757}
html,body{overflow-x:hidden}
body{font-family:'Noto Sans KR',sans-serif;background-color:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.6}
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{text-align:center;padding:30px 0 20px;border-bottom:1px solid var(--border-color);margin-bottom:20px}
.header h1{font-size:1.8rem;font-weight:700;letter-spacing:-0.5px;margin-bottom:6px;background:linear-gradient(135deg,#fff 0%,#888 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header p{color:var(--text-secondary);font-size:0.85rem}
.header .btc-price{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;color:var(--text-primary);margin-top:10px;-webkit-text-fill-color:initial}
.header .btc-price .dollar{color:var(--text-muted);font-weight:400}
.header .update-badge{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--text-muted);margin-top:4px}
.controls{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.control-group{display:flex;align-items:center;gap:4px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:4px}
.control-group label{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);padding:0 8px;text-transform:uppercase;letter-spacing:0.5px}
.control-btn{font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:500;padding:8px 14px;border-radius:8px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;transition:all 0.2s ease}
.control-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}
.control-btn.active{background:var(--bg-tertiary);border:1px solid var(--accent-yellow);color:var(--text-primary);box-shadow:0 0 12px rgba(255,212,59,0.1)}
.asset-toggles{display:flex;gap:6px;flex-wrap:wrap}
.asset-btn{font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:500;padding:8px 16px;border:1px solid var(--border-color);border-radius:10px;cursor:pointer;background:var(--bg-secondary);color:var(--text-secondary);transition:all 0.2s ease}
.asset-btn:hover{background:var(--bg-tertiary);border-color:#3a3a3a}
.asset-btn.active{color:#fff}
.asset-btn[data-asset="SPY"].active{background:var(--bg-tertiary);border-color:var(--color-spy);box-shadow:0 0 12px rgba(77,171,247,0.15)}
.asset-btn[data-asset="QQQ"].active{background:var(--bg-tertiary);border-color:var(--color-qqq);box-shadow:0 0 12px rgba(177,151,252,0.15)}
.asset-btn[data-asset="IGV"].active{background:var(--bg-tertiary);border-color:var(--color-igv);box-shadow:0 0 12px rgba(0,212,170,0.15)}
.asset-btn[data-asset="GLD"].active{background:var(--bg-tertiary);border-color:var(--color-gld);box-shadow:0 0 12px rgba(255,212,59,0.15);color:var(--color-gld)}
.asset-btn[data-asset="DXY"].active{background:var(--bg-tertiary);border-color:var(--color-dxy);box-shadow:0 0 12px rgba(255,71,87,0.15)}
.corr-stats{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-bottom:20px}
.corr-stat-item{display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:0.75rem}
.corr-stat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.corr-stat-name{color:var(--text-secondary)}
.corr-stat-value{font-weight:600}
.corr-positive{color:var(--accent-green)}
.corr-negative{color:var(--accent-red)}
.corr-neutral{color:var(--text-secondary)}
.chart-section{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.section-title{font-size:1.1rem;font-weight:600}
.section-subtitle{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
#candlestick-chart{width:100%}
.corr-chart-box{position:relative;width:100%;height:280px}
#correlation-chart{width:100%;max-height:280px}
.watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'JetBrains Mono',monospace;font-size:48px;font-weight:700;color:rgba(255,255,255,0.015);pointer-events:none;z-index:1;white-space:nowrap;letter-spacing:4px}
.footer{text-align:center;padding:20px;color:var(--text-muted);font-size:0.75rem}
.share-buttons{display:flex;gap:8px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
.share-btn{display:inline-flex;align-items:center;gap:6px;font-family:'Noto Sans KR',sans-serif;font-size:0.75rem;font-weight:400;padding:8px 16px;border:1px solid #333;border-radius:20px;background:transparent;color:#ccc;cursor:pointer;transition:all 0.2s ease;text-decoration:none}
.share-btn:hover{background:var(--bg-tertiary);color:var(--text-primary);border-color:#555}
.share-btn svg{width:14px;height:14px;flex-shrink:0}
.footer-info{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--text-muted)}
.loading-overlay{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity 0.4s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:30px;height:30px;border:3px solid var(--border-color);border-top-color:var(--accent-yellow);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:768px){
  .container{padding:12px}
  .header{padding:20px 0 15px;margin-bottom:15px}
  .header h1{font-size:1.4rem}
  .header p{font-size:0.75rem}
  .header .btc-price{font-size:1.6rem}
  .controls{gap:6px;margin-bottom:15px}
  .control-btn{padding:6px 10px;font-size:0.65rem}
  .asset-btn{padding:6px 10px;font-size:0.65rem}
  .chart-section{padding:15px 12px;border-radius:10px;margin-bottom:15px}
  .section-title{font-size:1rem}
  .corr-chart-box{height:220px}
  #correlation-chart{max-height:220px}
  .corr-stats{gap:10px}
  .corr-stat-item{font-size:0.65rem}
  .watermark{font-size:28px}
  .footer{padding:15px;font-size:0.65rem}
}
@media(max-width:480px){
  .container{padding:10px}
  .header h1{font-size:1.2rem}
  .header .btc-price{font-size:1.4rem}
  .control-btn{padding:5px 8px;font-size:0.6rem}
  .asset-btn{padding:5px 8px;font-size:0.6rem}
  .section-title{font-size:0.9rem}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
</div>

<div class="container">
    <header class="header">
        <h1>비트코인 자산 상관관계</h1>
        <p>주간 롤링 상관계수 · SPY · QQQ · IGV · GLD · DXY</p>
        <div class="btc-price">
            <span class="dollar">$</span><span id="btc-price-value">--</span>
        </div>
        <div class="update-badge">Updated: <span id="last-updated">--</span></div>
    </header>

    <nav class="controls">
        <div class="control-group">
            <label>Period</label>
            <button class="control-btn" data-period="13" onclick="setPeriod(13)">13W</button>
            <button class="control-btn active" data-period="26" onclick="setPeriod(26)">26W</button>
            <button class="control-btn" data-period="52" onclick="setPeriod(52)">52W</button>
        </div>
        <div class="asset-toggles">
            <button class="asset-btn active" data-asset="SPY" onclick="toggleAsset('SPY')">SPY</button>
            <button class="asset-btn" data-asset="QQQ" onclick="toggleAsset('QQQ')">QQQ</button>
            <button class="asset-btn" data-asset="IGV" onclick="toggleAsset('IGV')">IGV</button>
            <button class="asset-btn" data-asset="GLD" onclick="toggleAsset('GLD')">GLD</button>
            <button class="asset-btn" data-asset="DXY" onclick="toggleAsset('DXY')">DXY</button>
        </div>
    </nav>

    <div class="corr-stats" id="corr-stats"></div>

    <section class="chart-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">BTC/USD</h2>
                <span class="section-subtitle">Weekly Candlestick</span>
            </div>
        </div>
        <div class="watermark">HERDVIBE</div>
        <div id="candlestick-chart"></div>
    </section>

    <section class="chart-section">
        <div class="section-header">
            <div>
                <h2 class="section-title" id="corr-title">26주 롤링 상관관계</h2>
                <span class="section-subtitle">비트코인과의 피어슨 상관계수</span>
            </div>
        </div>
        <div class="watermark" style="font-size:36px;">HERDVIBE</div>
        <div class="corr-chart-box">
            <canvas id="correlation-chart"></canvas>
        </div>
    </section>

    <footer class="footer">
        <div class="share-buttons">
            <a class="share-btn" id="share-x" href="#" target="_blank">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                트위터
            </a>
            <button class="share-btn" id="share-kakao" onclick="shareKakao()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-5.523 0-10 3.582-10 8 0 2.868 1.893 5.382 4.736 6.806-.152.56-.874 3.226-.899 3.424 0 0-.019.154.073.213.092.06.2.027.2.027.264-.037 3.063-1.998 3.545-2.34.77.112 1.565.17 2.345.17 5.523 0 10-3.582 10-8s-4.477-8-10-8z"/></svg>
                카카오톡
            </button>
            <a class="share-btn" id="share-telegram" href="#" target="_blank">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                텔레그램
            </a>
            <button class="share-btn" onclick="shareInstagram()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/></svg>
                인스타그램
            </button>
            <button class="share-btn" onclick="copyLink()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                링크복사
            </button>
        </div>
        <div class="footer-info">
            Last updated: <span id="footer-date">--</span> · Weekly Rolling Correlation
        </div>
    </footer>
</div>

<script>
let DATA = null;
let currentPeriod = 26;
let activeAssets = new Set(['SPY']);
let candlestickChart = null;
let correlationChart = null;

const ASSET_COLORS = {
  SPY: { line: '#4dabf7', bg: 'rgba(77,171,247,0.08)' },
  QQQ: { line: '#b197fc', bg: 'rgba(177,151,252,0.08)' },
  IGV: { line: '#00d4aa', bg: 'rgba(0,212,170,0.08)' },
  GLD: { line: '#ffd43b', bg: 'rgba(255,212,59,0.08)' },
  DXY: { line: '#ff4757', bg: 'rgba(255,71,87,0.08)' },
};

const ASSET_LABELS = {
  SPY: 'S&P 500', QQQ: 'NASDAQ 100', IGV: 'Software', GLD: 'Gold', DXY: 'US Dollar',
};

// === MODIFIED: Compact price formatter ===
function formatBtcPrice(price) {
  if (price >= 1000) return '$' + (price / 1000).toFixed(0) + 'k';
  if (price >= 1) return '$' + price.toFixed(0);
  return '$' + price.toFixed(2);
}

async function loadData() {
  try {
    const resp = await fetch('data.json');
    DATA = await resp.json();
  } catch (e) {
    console.error('Failed to load data.json:', e);
    document.getElementById('loading').innerHTML =
      '<div style="color:#ff4757;font-size:0.85rem;">데이터 로드 실패. data.json을 확인하세요.</div>';
    return;
  }
  document.getElementById('btc-price-value').textContent =
    Number(DATA.btcLatest).toLocaleString('en-US', { maximumFractionDigits: 0 });
  document.getElementById('last-updated').textContent = DATA.lastUpdated;
  initCandlestickChart();
  initCorrelationChart();
  updateCorrelationStats();
  setupShareLinks();
  setTimeout(() => document.getElementById('loading').classList.add('hidden'), 300);
}

// === MODIFIED: Candlestick Chart with compact price labels ===
function initCandlestickChart() {
  const container = document.getElementById('candlestick-chart');
  const width = container.parentElement.clientWidth - 40;
  const isMobile = window.innerWidth <= 768;
  const height = isMobile
    ? Math.min(300, window.innerHeight * 0.30)
    : Math.min(420, window.innerHeight * 0.38);
  const fontSize = isMobile ? 9 : 11;

  candlestickChart = LightweightCharts.createChart(container, {
    width: width,
    height: height,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#555555',
      fontFamily: "'JetBrains Mono', monospace",
      fontSize: fontSize,
    },
    localization: {
      priceFormatter: formatBtcPrice,
    },
    grid: {
      vertLines: { color: 'rgba(255, 255, 255, 0.04)' },
      horzLines: { color: 'rgba(255, 255, 255, 0.04)' },
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal,
      vertLine: { color: 'rgba(255,255,255,0.1)', width: 1, style: 3 },
      horzLine: { color: 'rgba(255,255,255,0.1)', width: 1, style: 3, labelBackgroundColor: '#333' },
    },
    rightPriceScale: {
      borderColor: 'rgba(255, 255, 255, 0.06)',
      scaleMargins: { top: 0.1, bottom: 0.05 },
      entireTextOnly: true,
    },
    timeScale: {
      borderColor: 'rgba(255, 255, 255, 0.06)',
      timeVisible: false,
      fixLeftEdge: true,
      fixRightEdge: true,
    },
    handleScroll: { vertTouchDrag: false },
  });

  const series = candlestickChart.addCandlestickSeries({
    upColor: '#00d4aa',
    downColor: '#ff4757',
    borderUpColor: '#00d4aa',
    borderDownColor: '#ff4757',
    wickUpColor: '#00d4aa',
    wickDownColor: '#ff4757',
    priceFormat: {
      type: 'custom',
      formatter: formatBtcPrice,
      minMove: 1,
    },
  });

  const candleData = DATA.candles
    .filter(c => c.o && c.h && c.l && c.c)
    .map(c => ({ time: c.t, open: c.o, high: c.h, low: c.l, close: c.c }));

  series.setData(candleData);
  candlestickChart.timeScale().fitContent();

  const ro = new ResizeObserver(() => {
    const w = container.parentElement.clientWidth - 40;
    const mobile = window.innerWidth <= 768;
    const h = mobile
      ? Math.min(300, window.innerHeight * 0.30)
      : Math.min(420, window.innerHeight * 0.38);
    candlestickChart.applyOptions({ width: w, height: h });
  });
  ro.observe(container.parentElement);
}

// Correlation Chart
let syncCrosshairX = null;
const crosshairSyncPlugin = {
  id: 'crosshairSync',
  afterDraw(chart) {
    if (syncCrosshairX === null) return;
    const { ctx, chartArea } = chart;
    if (!chartArea) return;
    ctx.save();
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 3]);
    ctx.beginPath();
    ctx.moveTo(syncCrosshairX, chartArea.top);
    ctx.lineTo(syncCrosshairX, chartArea.bottom);
    ctx.stroke();
    ctx.restore();
  }
};

function initCorrelationChart() {
  const ctx = document.getElementById('correlation-chart').getContext('2d');
  correlationChart = new Chart(ctx, {
    type: 'line',
    data: { datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(10, 10, 10, 0.95)',
          titleColor: '#fff', bodyColor: '#ccc',
          borderColor: '#333', borderWidth: 1,
          titleFont: { family: "'JetBrains Mono', monospace", size: 11 },
          bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
          padding: 12, cornerRadius: 8,
          callbacks: {
            label: function(ctx) {
              const val = ctx.parsed.y;
              if (val === null || val === undefined) return null;
              const sign = val >= 0 ? '+' : '';
              return '  ' + ctx.dataset.label + ': ' + sign + val.toFixed(3);
            }
          }
        },
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'year', displayFormats: { year: 'yyyy' } },
          grid: { color: 'rgba(255, 255, 255, 0.04)' },
          ticks: {
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            color: '#555555', maxTicksLimit: 12,
          },
          border: { color: 'rgba(255, 255, 255, 0.06)' },
        },
        y: {
          position: 'right', min: -1, max: 1,
          grid: { color: 'rgba(255, 255, 255, 0.04)' },
          ticks: {
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            color: '#555555', stepSize: 0.25,
            callback: v => v.toFixed(2),
          },
          border: { color: 'rgba(255, 255, 255, 0.06)' },
        },
      },
      elements: {
        point: { radius: 0, hoverRadius: 4 },
        line: { borderWidth: 2 },
      },
    },
    plugins: [
      {
        id: 'zeroLine',
        beforeDraw(chart) {
          const { ctx, chartArea, scales } = chart;
          if (!chartArea) return;
          const y0 = scales.y.getPixelForValue(0);
          ctx.save();
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.12)';
          ctx.lineWidth = 1.5;
          ctx.setLineDash([6, 4]);
          ctx.beginPath();
          ctx.moveTo(chartArea.left, y0);
          ctx.lineTo(chartArea.right, y0);
          ctx.stroke();
          ctx.restore();
        }
      },
      {
        id: 'extremeZones',
        beforeDraw(chart) {
          const { ctx, chartArea, scales } = chart;
          if (!chartArea) return;
          ctx.save();
          const y75 = scales.y.getPixelForValue(0.75);
          const y1 = scales.y.getPixelForValue(1);
          ctx.fillStyle = 'rgba(0, 212, 170, 0.04)';
          ctx.fillRect(chartArea.left, y1, chartArea.width, y75 - y1);
          const yN75 = scales.y.getPixelForValue(-0.75);
          const yN1 = scales.y.getPixelForValue(-1);
          ctx.fillStyle = 'rgba(255, 71, 87, 0.04)';
          ctx.fillRect(chartArea.left, yN75, chartArea.width, yN1 - yN75);
          ctx.restore();
        }
      },
      crosshairSyncPlugin,
    ],
  });
  updateCorrelationData();
}

function updateCorrelationData() {
  if (!DATA || !correlationChart) return;
  const corrData = DATA.correlations[String(currentPeriod)];
  if (!corrData) return;
  const datasets = [];
  for (const asset of ['SPY', 'QQQ', 'IGV', 'GLD', 'DXY']) {
    if (!activeAssets.has(asset)) continue;
    const points = corrData
      .filter(d => d[asset] !== null && d[asset] !== undefined)
      .map(d => ({ x: d.t, y: d[asset] }));
    datasets.push({
      label: asset + ' (' + ASSET_LABELS[asset] + ')',
      data: points,
      borderColor: ASSET_COLORS[asset].line,
      backgroundColor: ASSET_COLORS[asset].bg,
      fill: false, tension: 0.3, borderWidth: 2,
    });
  }
  correlationChart.data.datasets = datasets;
  correlationChart.update('none');
  document.getElementById('corr-title').textContent = currentPeriod + '주 롤링 상관관계';
}

function updateCorrelationStats() {
  if (!DATA) return;
  const corrData = DATA.correlations[String(currentPeriod)];
  if (!corrData) return;
  const latest = corrData[corrData.length - 1];
  const container = document.getElementById('corr-stats');
  container.innerHTML = '';
  for (const asset of ['SPY', 'QQQ', 'IGV', 'GLD', 'DXY']) {
    if (!activeAssets.has(asset)) continue;
    const val = latest[asset];
    if (val === null || val === undefined) continue;
    const cls = val > 0.1 ? 'corr-positive' : val < -0.1 ? 'corr-negative' : 'corr-neutral';
    const sign = val >= 0 ? '+' : '';
    const item = document.createElement('div');
    item.className = 'corr-stat-item';
    item.innerHTML = '<div class="corr-stat-dot" style="background:' + ASSET_COLORS[asset].line + '"></div>' +
      '<span class="corr-stat-name">' + asset + '</span>' +
      '<span class="corr-stat-value ' + cls + '">' + sign + val.toFixed(3) + '</span>';
    container.appendChild(item);
  }
}

function setPeriod(p) {
  currentPeriod = p;
  document.querySelectorAll('[data-period]').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.period) === p);
  });
  updateCorrelationData();
  updateCorrelationStats();
}

function toggleAsset(asset) {
  const btn = document.querySelector('[data-asset="' + asset + '"]');
  if (activeAssets.has(asset)) {
    activeAssets.delete(asset);
    btn.classList.remove('active');
  } else {
    activeAssets.add(asset);
    btn.classList.add('active');
  }
  updateCorrelationData();
  updateCorrelationStats();
}

// Share
const SHARE_URL = 'https://herdvibe.com/84';
const SHARE_TITLE = '비트코인 자산 상관관계 대시보드';

function setupShareLinks() {
  const text = encodeURIComponent('\u20bf ' + SHARE_TITLE + '\n\nBTC: $' + Number(DATA.btcLatest).toLocaleString() + '\n\n' + SHARE_URL);
  const url = encodeURIComponent(SHARE_URL);
  document.getElementById('share-x').href = 'https://twitter.com/intent/tweet?text=' + text;
  document.getElementById('share-telegram').href = 'https://t.me/share/url?url=' + url + '&text=' + encodeURIComponent('\u20bf ' + SHARE_TITLE + '\nBTC: $' + Number(DATA.btcLatest).toLocaleString());
  document.getElementById('footer-date').textContent = DATA.lastUpdated;
  if (window.Kakao && !Kakao.isInitialized()) {
    Kakao.init('a43ed7b39fac35458f4f9df925a279b5');
  }
}

function shareKakao() {
  if (!window.Kakao || !Kakao.isInitialized()) {
    alert('카카오 SDK 로딩 중입니다. 잠시 후 다시 시도해주세요.');
    return;
  }
  Kakao.Share.sendDefault({
    objectType: 'feed',
    content: {
      title: SHARE_TITLE,
      description: 'BTC: $' + Number(DATA.btcLatest).toLocaleString() + ' \u00b7 SPY/QQQ/IGV/GLD/DXY 상관관계 분석',
      imageUrl: 'https://herdvibe.com/og-image.png',
      link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL },
    },
    buttons: [{ title: '대시보드 보기', link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL } }],
  });
}

function shareInstagram() {
  navigator.clipboard.writeText(SHARE_URL).then(() => {
    alert('링크가 복사되었습니다. 인스타그램 스토리에 붙여넣기 해주세요!');
    window.open('https://www.instagram.com/', '_blank');
  }).catch(() => {
    window.open('https://www.instagram.com/', '_blank');
  });
}

function copyLink() {
  navigator.clipboard.writeText(SHARE_URL).then(() => {
    const btn = event.currentTarget;
    const original = btn.innerHTML;
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#00d4aa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> 복사완료';
    btn.style.borderColor = '#00d4aa';
    btn.style.color = '#00d4aa';
    setTimeout(() => { btn.innerHTML = original; btn.style.borderColor = ''; btn.style.color = ''; }, 2000);
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = SHARE_URL;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('링크가 복사되었습니다!');
  });
}

// Sync
function setupCrosshairSync() {
  if (!candlestickChart || !correlationChart) return;
  candlestickChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
    if (!range || !correlationChart) return;
    const from = range.from;
    const to = range.to;
    if (!from || !to) return;
    correlationChart.options.scales.x.min = from;
    correlationChart.options.scales.x.max = to;
    correlationChart.update('none');
  });
  candlestickChart.subscribeCrosshairMove((param) => {
    if (!param.time || !correlationChart) {
      syncCrosshairX = null;
      correlationChart.update('none');
      return;
    }
    const t = param.time;
    const dateStr = typeof t === 'string' ? t
      : t.year + '-' + String(t.month).padStart(2,'0') + '-' + String(t.day).padStart(2,'0');
    const scale = correlationChart.scales.x;
    if (!scale) return;
    const px = scale.getPixelForValue(new Date(dateStr).getTime());
    if (px >= correlationChart.chartArea.left && px <= correlationChart.chartArea.right) {
      syncCrosshairX = px;
    } else {
      syncCrosshairX = null;
    }
    correlationChart.update('none');
  });
}

loadData().then(() => { setupCrosshairSync(); });
</script>
</body>
</html>
