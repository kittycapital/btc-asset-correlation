<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bitcoin Correlation Dashboard | Herdvibe</title>
<meta name="description" content="Bitcoin weekly chart with rolling correlation against SPY, QQQ, IGV, GLD, DXY">

<!-- Open Graph -->
<meta property="og:title" content="Bitcoin Correlation Dashboard">
<meta property="og:description" content="ÎπÑÌä∏ÏΩîÏù∏Í≥º Ï£ºÏöî ÏûêÏÇ∞ Í∞Ñ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù">
<meta property="og:type" content="website">

<!-- TradingView Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    ::-webkit-scrollbar { display: none; }
    * {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    :root {
        --bg-primary: #0a0a0a;
        --bg-secondary: #111111;
        --bg-tertiary: #1a1a1a;
        --text-primary: #ffffff;
        --text-secondary: #888888;
        --text-muted: #555555;
        --accent-green: #00d4aa;
        --accent-red: #ff4757;
        --accent-yellow: #ffd43b;
        --accent-blue: #4dabf7;
        --border-color: #2a2a2a;
        --color-spy: #4dabf7;
        --color-qqq: #b197fc;
        --color-igv: #00d4aa;
        --color-gld: #ffd43b;
        --color-dxy: #ff4757;
    }

    html, body { overflow-x: hidden; }

    body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header */
    .header {
        text-align: center;
        padding: 30px 0 20px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
    }

    .header h1 {
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: -0.5px;
        margin-bottom: 6px;
        background: linear-gradient(135deg, #fff 0%, #888 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header p {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .header .btc-price {
        font-family: 'JetBrains Mono', monospace;
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-top: 10px;
        -webkit-text-fill-color: initial;
    }

    .header .btc-price .dollar {
        color: var(--text-muted);
        font-weight: 400;
    }

    .header .update-badge {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    /* Controls */
    .controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 4px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 4px;
    }

    .control-group label {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        color: var(--text-muted);
        padding: 0 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .control-btn {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 8px 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: transparent;
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }

    .control-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .control-btn.active {
        background: var(--bg-tertiary);
        border: 1px solid var(--accent-yellow);
        color: var(--text-primary);
        box-shadow: 0 0 12px rgba(255, 212, 59, 0.1);
    }

    .asset-toggles {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .asset-btn {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        cursor: pointer;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }

    .asset-btn:hover { background: var(--bg-tertiary); border-color: #3a3a3a; }
    .asset-btn.active { color: #fff; }
    .asset-btn[data-asset="SPY"].active { background: var(--bg-tertiary); border-color: var(--color-spy); box-shadow: 0 0 12px rgba(77,171,247,0.15); }
    .asset-btn[data-asset="QQQ"].active { background: var(--bg-tertiary); border-color: var(--color-qqq); box-shadow: 0 0 12px rgba(177,151,252,0.15); }
    .asset-btn[data-asset="IGV"].active { background: var(--bg-tertiary); border-color: var(--color-igv); box-shadow: 0 0 12px rgba(0,212,170,0.15); }
    .asset-btn[data-asset="GLD"].active { background: var(--bg-tertiary); border-color: var(--color-gld); box-shadow: 0 0 12px rgba(255,212,59,0.15); color: var(--color-gld); }
    .asset-btn[data-asset="DXY"].active { background: var(--bg-tertiary); border-color: var(--color-dxy); box-shadow: 0 0 12px rgba(255,71,87,0.15); }

    /* Correlation Stats */
    .corr-stats {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
    }

    .corr-stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
    }

    .corr-stat-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .corr-stat-name { color: var(--text-secondary); }
    .corr-stat-value { font-weight: 600; }
    .corr-positive { color: var(--accent-green); }
    .corr-negative { color: var(--accent-red); }
    .corr-neutral { color: var(--text-secondary); }

    /* Chart Sections */
    .chart-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .section-subtitle {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    #candlestick-chart { width: 100%; }

    .corr-chart-box {
        position: relative;
        width: 100%;
        height: 280px;
    }

    #correlation-chart {
        width: 100%;
        max-height: 280px;
    }

    .watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'JetBrains Mono', monospace;
        font-size: 48px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.015);
        pointer-events: none;
        z-index: 1;
        white-space: nowrap;
        letter-spacing: 4px;
    }

    /* Footer */
    .footer {
        text-align: center;
        padding: 20px;
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .share-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 10px;
    }

    .share-btn {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        padding: 6px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .share-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-color: #3a3a3a;
    }

    /* Loading */
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.4s;
    }

    .loading-overlay.hidden { opacity: 0; pointer-events: none; }

    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid var(--border-color);
        border-top-color: var(--accent-yellow);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
        .container { padding: 12px; }
        .header { padding: 20px 0 15px; margin-bottom: 15px; }
        .header h1 { font-size: 1.4rem; }
        .header p { font-size: 0.75rem; }
        .header .btc-price { font-size: 1.6rem; }
        .controls { gap: 6px; margin-bottom: 15px; }
        .control-btn { padding: 6px 10px; font-size: 0.65rem; }
        .asset-btn { padding: 6px 10px; font-size: 0.65rem; }
        .chart-section { padding: 15px 12px; border-radius: 10px; margin-bottom: 15px; }
        .section-title { font-size: 1rem; }
        .corr-chart-box { height: 220px; }
        #correlation-chart { max-height: 220px; }
        .corr-stats { gap: 10px; }
        .corr-stat-item { font-size: 0.65rem; }
        .watermark { font-size: 28px; }
        .footer { padding: 15px; font-size: 0.65rem; }
    }

    @media (max-width: 480px) {
        .container { padding: 10px; }
        .header h1 { font-size: 1.2rem; }
        .header .btc-price { font-size: 1.4rem; }
        .control-btn { padding: 5px 8px; font-size: 0.6rem; }
        .asset-btn { padding: 5px 8px; font-size: 0.6rem; }
        .section-title { font-size: 0.9rem; }
    }
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
</div>

<div class="container">
    <!-- Header -->
    <header class="header">
        <h1>ÎπÑÌä∏ÏΩîÏù∏ ÏûêÏÇ∞ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</h1>
        <p>Ï£ºÍ∞Ñ Î°§ÎßÅ ÏÉÅÍ¥ÄÍ≥ÑÏàò ¬∑ SPY ¬∑ QQQ ¬∑ IGV ¬∑ GLD ¬∑ DXY</p>
        <div class="btc-price">
            <span class="dollar">$</span><span id="btc-price-value">--</span>
        </div>
        <div class="update-badge">Updated: <span id="last-updated">--</span></div>
    </header>

    <!-- Controls -->
    <nav class="controls">
        <div class="control-group">
            <label>Period</label>
            <button class="control-btn" data-period="13" onclick="setPeriod(13)">13W</button>
            <button class="control-btn active" data-period="26" onclick="setPeriod(26)">26W</button>
            <button class="control-btn" data-period="52" onclick="setPeriod(52)">52W</button>
        </div>
        <div class="asset-toggles">
            <button class="asset-btn active" data-asset="SPY" onclick="toggleAsset('SPY')">SPY</button>
            <button class="asset-btn active" data-asset="QQQ" onclick="toggleAsset('QQQ')">QQQ</button>
            <button class="asset-btn active" data-asset="IGV" onclick="toggleAsset('IGV')">IGV</button>
            <button class="asset-btn active" data-asset="GLD" onclick="toggleAsset('GLD')">GLD</button>
            <button class="asset-btn active" data-asset="DXY" onclick="toggleAsset('DXY')">DXY</button>
        </div>
    </nav>

    <!-- Correlation Stats -->
    <div class="corr-stats" id="corr-stats"></div>

    <!-- Candlestick Chart -->
    <section class="chart-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">BTC/USD</h2>
                <span class="section-subtitle">Weekly Candlestick</span>
            </div>
        </div>
        <div class="watermark">HERDVIBE</div>
        <div id="candlestick-chart"></div>
    </section>

    <!-- Correlation Chart -->
    <section class="chart-section">
        <div class="section-header">
            <div>
                <h2 class="section-title" id="corr-title">26-Week Rolling Correlation</h2>
                <span class="section-subtitle">Pearson Correlation Coefficient with Bitcoin</span>
            </div>
        </div>
        <div class="watermark" style="font-size:36px;">HERDVIBE</div>
        <div class="corr-chart-box">
            <canvas id="correlation-chart"></canvas>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        Îç∞Ïù¥ÌÑ∞ Ï∂úÏ≤ò: Yahoo Finance | Îß§Ïùº ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
        <div class="share-buttons">
            <a class="share-btn" id="share-x" href="#" target="_blank">ùïè Share</a>
            <a class="share-btn" id="share-kakao" href="#" target="_blank">üí¨ KakaoTalk</a>
            <a class="share-btn" id="share-telegram" href="#" target="_blank">‚úàÔ∏è Telegram</a>
        </div>
    </footer>
</div>

<script>
// ============================================================
// State
// ============================================================
let DATA = null;
let currentPeriod = 26;
let activeAssets = new Set(['SPY', 'QQQ', 'IGV', 'GLD', 'DXY']);
let candlestickChart = null;
let correlationChart = null;

const ASSET_COLORS = {
  SPY: { line: '#4dabf7', bg: 'rgba(77,171,247,0.08)' },
  QQQ: { line: '#b197fc', bg: 'rgba(177,151,252,0.08)' },
  IGV: { line: '#00d4aa', bg: 'rgba(0,212,170,0.08)' },
  GLD: { line: '#ffd43b', bg: 'rgba(255,212,59,0.08)' },
  DXY: { line: '#ff4757', bg: 'rgba(255,71,87,0.08)' },
};

const ASSET_LABELS = {
  SPY: 'S&P 500',
  QQQ: 'NASDAQ 100',
  IGV: 'Software',
  GLD: 'Gold',
  DXY: 'US Dollar',
};

// ============================================================
// Load Data
// ============================================================
async function loadData() {
  try {
    const resp = await fetch('data.json');
    DATA = await resp.json();
  } catch (e) {
    console.error('Failed to load data.json:', e);
    document.getElementById('loading').innerHTML =
      '<div style="color:#ff4757;font-size:0.85rem;">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®. data.jsonÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</div>';
    return;
  }

  document.getElementById('btc-price-value').textContent =
    Number(DATA.btcLatest).toLocaleString('en-US', { maximumFractionDigits: 0 });
  document.getElementById('last-updated').textContent = DATA.lastUpdated;

  initCandlestickChart();
  initCorrelationChart();
  updateCorrelationStats();
  setupShareLinks();

  setTimeout(() => document.getElementById('loading').classList.add('hidden'), 300);
}

// ============================================================
// Candlestick Chart (TradingView Lightweight Charts)
// ============================================================
function initCandlestickChart() {
  const container = document.getElementById('candlestick-chart');
  const width = container.parentElement.clientWidth - 40;
  const height = Math.min(420, window.innerHeight * 0.38);

  candlestickChart = LightweightCharts.createChart(container, {
    width: width,
    height: height,
    layout: {
      background: { type: 'solid', color: 'transparent' },
      textColor: '#555555',
      fontFamily: "'JetBrains Mono', monospace",
      fontSize: 11,
    },
    grid: {
      vertLines: { color: 'rgba(255, 255, 255, 0.04)' },
      horzLines: { color: 'rgba(255, 255, 255, 0.04)' },
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal,
      vertLine: { color: 'rgba(255,255,255,0.1)', width: 1, style: 3 },
      horzLine: { color: 'rgba(255,255,255,0.1)', width: 1, style: 3 },
    },
    rightPriceScale: {
      borderColor: 'rgba(255, 255, 255, 0.06)',
      scaleMargins: { top: 0.1, bottom: 0.05 },
    },
    timeScale: {
      borderColor: 'rgba(255, 255, 255, 0.06)',
      timeVisible: false,
      fixLeftEdge: true,
      fixRightEdge: true,
    },
    handleScroll: { vertTouchDrag: false },
  });

  const series = candlestickChart.addCandlestickSeries({
    upColor: '#00d4aa',
    downColor: '#ff4757',
    borderUpColor: '#00d4aa',
    borderDownColor: '#ff4757',
    wickUpColor: '#00d4aa',
    wickDownColor: '#ff4757',
  });

  const candleData = DATA.candles
    .filter(c => c.o && c.h && c.l && c.c)
    .map(c => ({ time: c.t, open: c.o, high: c.h, low: c.l, close: c.c }));

  series.setData(candleData);
  candlestickChart.timeScale().fitContent();

  const ro = new ResizeObserver(() => {
    const w = container.parentElement.clientWidth - 40;
    candlestickChart.applyOptions({ width: w });
  });
  ro.observe(container.parentElement);
}

// ============================================================
// Correlation Chart (Chart.js)
// ============================================================
let syncCrosshairX = null;

const crosshairSyncPlugin = {
  id: 'crosshairSync',
  afterDraw(chart) {
    if (syncCrosshairX === null) return;
    const { ctx, chartArea } = chart;
    if (!chartArea) return;
    ctx.save();
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 3]);
    ctx.beginPath();
    ctx.moveTo(syncCrosshairX, chartArea.top);
    ctx.lineTo(syncCrosshairX, chartArea.bottom);
    ctx.stroke();
    ctx.restore();
  }
};

function initCorrelationChart() {
  const ctx = document.getElementById('correlation-chart').getContext('2d');

  correlationChart = new Chart(ctx, {
    type: 'line',
    data: { datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(10, 10, 10, 0.95)',
          titleColor: '#fff',
          bodyColor: '#ccc',
          borderColor: '#333',
          borderWidth: 1,
          titleFont: { family: "'JetBrains Mono', monospace", size: 11 },
          bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            label: function(ctx) {
              const val = ctx.parsed.y;
              if (val === null || val === undefined) return null;
              const sign = val >= 0 ? '+' : '';
              return `  ${ctx.dataset.label}: ${sign}${val.toFixed(3)}`;
            }
          }
        },
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'year', displayFormats: { year: 'yyyy' } },
          grid: { color: 'rgba(255, 255, 255, 0.04)' },
          ticks: {
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            color: '#555555',
            maxTicksLimit: 12,
          },
          border: { color: 'rgba(255, 255, 255, 0.06)' },
        },
        y: {
          position: 'right',
          min: -1,
          max: 1,
          grid: { color: 'rgba(255, 255, 255, 0.04)' },
          ticks: {
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            color: '#555555',
            stepSize: 0.25,
            callback: v => v.toFixed(2),
          },
          border: { color: 'rgba(255, 255, 255, 0.06)' },
        },
      },
      elements: {
        point: { radius: 0, hoverRadius: 4 },
        line: { borderWidth: 2 },
      },
    },
    plugins: [
      {
        id: 'zeroLine',
        beforeDraw(chart) {
          const { ctx, chartArea, scales } = chart;
          if (!chartArea) return;
          const y0 = scales.y.getPixelForValue(0);
          ctx.save();
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.12)';
          ctx.lineWidth = 1.5;
          ctx.setLineDash([6, 4]);
          ctx.beginPath();
          ctx.moveTo(chartArea.left, y0);
          ctx.lineTo(chartArea.right, y0);
          ctx.stroke();
          ctx.restore();
        }
      },
      {
        id: 'extremeZones',
        beforeDraw(chart) {
          const { ctx, chartArea, scales } = chart;
          if (!chartArea) return;
          ctx.save();
          const y75 = scales.y.getPixelForValue(0.75);
          const y1 = scales.y.getPixelForValue(1);
          ctx.fillStyle = 'rgba(0, 212, 170, 0.04)';
          ctx.fillRect(chartArea.left, y1, chartArea.width, y75 - y1);
          const yN75 = scales.y.getPixelForValue(-0.75);
          const yN1 = scales.y.getPixelForValue(-1);
          ctx.fillStyle = 'rgba(255, 71, 87, 0.04)';
          ctx.fillRect(chartArea.left, yN75, chartArea.width, yN1 - yN75);
          ctx.restore();
        }
      },
      crosshairSyncPlugin,
    ],
  });

  updateCorrelationData();
}

function updateCorrelationData() {
  if (!DATA || !correlationChart) return;
  const corrData = DATA.correlations[String(currentPeriod)];
  if (!corrData) return;

  const datasets = [];
  for (const asset of ['SPY', 'QQQ', 'IGV', 'GLD', 'DXY']) {
    if (!activeAssets.has(asset)) continue;
    const points = corrData
      .filter(d => d[asset] !== null && d[asset] !== undefined)
      .map(d => ({ x: d.t, y: d[asset] }));
    datasets.push({
      label: `${asset} (${ASSET_LABELS[asset]})`,
      data: points,
      borderColor: ASSET_COLORS[asset].line,
      backgroundColor: ASSET_COLORS[asset].bg,
      fill: false,
      tension: 0.3,
      borderWidth: 2,
    });
  }

  correlationChart.data.datasets = datasets;
  correlationChart.update('none');
  document.getElementById('corr-title').textContent = `${currentPeriod}-Week Rolling Correlation`;
}

// ============================================================
// Correlation Stats
// ============================================================
function updateCorrelationStats() {
  if (!DATA) return;
  const corrData = DATA.correlations[String(currentPeriod)];
  if (!corrData) return;

  const latest = corrData[corrData.length - 1];
  const container = document.getElementById('corr-stats');
  container.innerHTML = '';

  for (const asset of ['SPY', 'QQQ', 'IGV', 'GLD', 'DXY']) {
    if (!activeAssets.has(asset)) continue;
    const val = latest[asset];
    if (val === null || val === undefined) continue;
    const cls = val > 0.1 ? 'corr-positive' : val < -0.1 ? 'corr-negative' : 'corr-neutral';
    const sign = val >= 0 ? '+' : '';
    const item = document.createElement('div');
    item.className = 'corr-stat-item';
    item.innerHTML = `
      <div class="corr-stat-dot" style="background:${ASSET_COLORS[asset].line}"></div>
      <span class="corr-stat-name">${asset}</span>
      <span class="corr-stat-value ${cls}">${sign}${val.toFixed(3)}</span>
    `;
    container.appendChild(item);
  }
}

// ============================================================
// Controls
// ============================================================
function setPeriod(p) {
  currentPeriod = p;
  document.querySelectorAll('[data-period]').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.period) === p);
  });
  updateCorrelationData();
  updateCorrelationStats();
}

function toggleAsset(asset) {
  const btn = document.querySelector(`[data-asset="${asset}"]`);
  if (activeAssets.has(asset)) {
    activeAssets.delete(asset);
    btn.classList.remove('active');
  } else {
    activeAssets.add(asset);
    btn.classList.add('active');
  }
  updateCorrelationData();
  updateCorrelationStats();
}

// ============================================================
// Share
// ============================================================
function setupShareLinks() {
  const url = encodeURIComponent('https://herdvibe.com/84');
  const text = encodeURIComponent(`‚Çø Bitcoin Correlation Dashboard - ÎπÑÌä∏ÏΩîÏù∏Í≥º Ï£ºÏöî ÏûêÏÇ∞ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù\n\nBTC: $${Number(DATA.btcLatest).toLocaleString()}`);
  document.getElementById('share-x').href = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
  document.getElementById('share-kakao').href = `https://story.kakao.com/share?url=${url}`;
  document.getElementById('share-telegram').href = `https://t.me/share/url?url=${url}&text=${text}`;
}

// ============================================================
// Sync: Time Range + Crosshair
// ============================================================
function setupCrosshairSync() {
  if (!candlestickChart || !correlationChart) return;

  candlestickChart.timeScale().subscribeVisibleTimeRangeChange((range) => {
    if (!range || !correlationChart) return;
    const from = range.from;
    const to = range.to;
    if (!from || !to) return;
    correlationChart.options.scales.x.min = from;
    correlationChart.options.scales.x.max = to;
    correlationChart.update('none');
  });

  candlestickChart.subscribeCrosshairMove((param) => {
    if (!param.time || !correlationChart) {
      syncCrosshairX = null;
      correlationChart.update('none');
      return;
    }
    const t = param.time;
    const dateStr = typeof t === 'string' ? t
      : `${t.year}-${String(t.month).padStart(2,'0')}-${String(t.day).padStart(2,'0')}`;
    const scale = correlationChart.scales.x;
    if (!scale) return;
    const px = scale.getPixelForValue(new Date(dateStr).getTime());
    if (px >= correlationChart.chartArea.left && px <= correlationChart.chartArea.right) {
      syncCrosshairX = px;
    } else {
      syncCrosshairX = null;
    }
    correlationChart.update('none');
  });
}

// ============================================================
// Init
// ============================================================
loadData().then(() => { setupCrosshairSync(); });
</script>
</body>
</html>
