<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<title>Bitcoin Correlation Dashboard | Herdvibe</title>
<meta name="description" content="Bitcoin weekly chart with rolling correlation against SPY, QQQ, IGV, GLD, DXY">
<meta property="og:title" content="Bitcoin Correlation Dashboard">
<meta property="og:description" content="비트코인과 주요 자산 간 상관관계 분석">
<meta property="og:type" content="website">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js" integrity="sha384-DKYJZ8NLiK8MN4/C5P2vDkVBLkWgJJeCi06ioih4sFIzjIoFcsaZMzVIWKKPYrk" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
::-webkit-scrollbar{display:none}
*{-ms-overflow-style:none;scrollbar-width:none}
:root{--bg-primary:#0a0a0a;--bg-secondary:#111111;--bg-tertiary:#1a1a1a;--text-primary:#ffffff;--text-secondary:#888888;--text-muted:#555555;--accent-green:#00d4aa;--accent-red:#ff4757;--accent-yellow:#ffd43b;--accent-blue:#4dabf7;--border-color:#2a2a2a;--color-spy:#4dabf7;--color-qqq:#b197fc;--color-igv:#00d4aa;--color-gld:#ffd43b;--color-dxy:#ff4757}
html,body{overflow-x:hidden}
body{font-family:'Noto Sans KR',sans-serif;background-color:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.6}
.container{max-width:1400px;margin:0 auto;padding:20px}
.header{text-align:center;padding:30px 0 20px;border-bottom:1px solid var(--border-color);margin-bottom:20px}
.header h1{font-size:1.8rem;font-weight:700;letter-spacing:-0.5px;margin-bottom:6px;background:linear-gradient(135deg,#fff 0%,#888 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header p{color:var(--text-secondary);font-size:0.85rem}
.header .btc-price{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;color:var(--text-primary);margin-top:10px;-webkit-text-fill-color:initial}
.header .btc-price .dollar{color:var(--text-muted);font-weight:400}
.header .update-badge{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--text-muted);margin-top:4px}
.live-dot{display:inline-block;width:6px;height:6px;background:#22c55e;border-radius:50%;margin-left:4px;vertical-align:middle;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.controls{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.control-group{display:flex;align-items:center;gap:4px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:4px}
.control-group label{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);padding:0 8px;text-transform:uppercase;letter-spacing:0.5px}
.control-btn{font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:500;padding:8px 14px;border-radius:8px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;transition:all 0.2s ease}
.control-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}
.control-btn.active{background:var(--bg-tertiary);border:1px solid var(--accent-yellow);color:var(--text-primary);box-shadow:0 0 12px rgba(255,212,59,0.1)}
.asset-toggles{display:flex;gap:6px;flex-wrap:wrap}
.asset-btn{font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:500;padding:8px 16px;border:1px solid var(--border-color);border-radius:10px;cursor:pointer;background:var(--bg-secondary);color:var(--text-secondary);transition:all 0.2s ease}
.asset-btn:hover{background:var(--bg-tertiary);border-color:#3a3a3a}
.asset-btn.active{color:#fff}
.asset-btn[data-asset="SPY"].active{background:var(--bg-tertiary);border-color:var(--color-spy);box-shadow:0 0 12px rgba(77,171,247,0.15)}
.asset-btn[data-asset="QQQ"].active{background:var(--bg-tertiary);border-color:var(--color-qqq);box-shadow:0 0 12px rgba(177,151,252,0.15)}
.asset-btn[data-asset="IGV"].active{background:var(--bg-tertiary);border-color:var(--color-igv);box-shadow:0 0 12px rgba(0,212,170,0.15)}
.asset-btn[data-asset="GLD"].active{background:var(--bg-tertiary);border-color:var(--color-gld);box-shadow:0 0 12px rgba(255,212,59,0.15);color:var(--color-gld)}
.asset-btn[data-asset="DXY"].active{background:var(--bg-tertiary);border-color:var(--color-dxy);box-shadow:0 0 12px rgba(255,71,87,0.15)}
.corr-stats{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-bottom:20px}
.corr-stat-item{display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:0.75rem}
.corr-stat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.corr-stat-name{color:var(--text-secondary)}
.corr-stat-value{font-weight:600}
.corr-positive{color:var(--accent-green)}
.corr-negative{color:var(--accent-red)}
.corr-neutral{color:var(--text-secondary)}
.chart-section{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.section-title{font-size:1.1rem;font-weight:600}
.section-subtitle{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}
.btc-chart-wrapper{position:relative;height:380px}
.btc-chart-wrapper canvas{width:100%!important;height:100%!important}
.corr-chart-box{position:relative;width:100%;height:280px}
#correlation-chart{width:100%;max-height:280px}
.watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'JetBrains Mono',monospace;font-size:48px;font-weight:700;color:rgba(255,255,255,0.015);pointer-events:none;z-index:1;white-space:nowrap;letter-spacing:4px}
.tabs{display:flex;gap:4px;background:var(--bg-tertiary);border-radius:8px;padding:3px}
.tab-btn{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;padding:5px 14px;border-radius:6px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;transition:all 0.2s}
.tab-btn:hover{color:var(--text-secondary)}
.tab-btn.active{background:var(--bg-secondary);color:var(--text-primary)}
.footer{text-align:center;padding:20px;color:var(--text-muted);font-size:0.75rem}
.share-buttons{display:flex;gap:8px;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
.share-btn{display:inline-flex;align-items:center;gap:6px;font-family:'Noto Sans KR',sans-serif;font-size:0.75rem;font-weight:400;padding:8px 16px;border:1px solid #333;border-radius:20px;background:transparent;color:#ccc;cursor:pointer;transition:all 0.2s ease;text-decoration:none}
.share-btn:hover{background:var(--bg-tertiary);color:var(--text-primary);border-color:#555}
.share-btn svg{width:14px;height:14px;flex-shrink:0}
.footer-info{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--text-muted)}
.loading-overlay{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity 0.4s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:30px;height:30px;border:3px solid var(--border-color);border-top-color:var(--accent-yellow);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:768px){
  .container{padding:12px}
  .header{padding:20px 0 15px;margin-bottom:15px}
  .header h1{font-size:1.4rem}
  .header p{font-size:0.75rem}
  .header .btc-price{font-size:1.6rem}
  .controls{gap:6px;margin-bottom:15px}
  .control-btn{padding:6px 10px;font-size:0.65rem}
  .asset-btn{padding:6px 10px;font-size:0.65rem}
  .chart-section{padding:15px 12px;border-radius:10px;margin-bottom:15px}
  .section-title{font-size:1rem}
  .btc-chart-wrapper{height:300px}
  .corr-chart-box{height:220px}
  #correlation-chart{max-height:220px}
  .corr-stats{gap:10px}
  .corr-stat-item{font-size:0.65rem}
  .watermark{font-size:28px}
  .footer{padding:15px;font-size:0.65rem}
}
@media(max-width:480px){
  .container{padding:10px}
  .header h1{font-size:1.2rem}
  .header .btc-price{font-size:1.4rem}
  .control-btn{padding:5px 8px;font-size:0.6rem}
  .asset-btn{padding:5px 8px;font-size:0.6rem}
  .section-title{font-size:0.9rem}
  .btc-chart-wrapper{height:260px}
}
</style>
</head>
<body>

<div class="loading-overlay" id="loading">
    <div class="spinner"></div>
</div>

<div class="container">
    <header class="header">
        <h1>비트코인 자산 상관관계</h1>
        <p>주간 롤링 상관계수 · SPY · QQQ · IGV · GLD · DXY</p>
        <div class="btc-price">
            <span class="dollar">$</span><span id="btc-price-value">--</span>
        </div>
        <div class="update-badge">Updated: <span id="last-updated">--</span></div>
    </header>

    <nav class="controls">
        <div class="control-group">
            <label>Period</label>
            <button class="control-btn" data-period="13" onclick="setPeriod(13)">13W</button>
            <button class="control-btn active" data-period="26" onclick="setPeriod(26)">26W</button>
            <button class="control-btn" data-period="52" onclick="setPeriod(52)">52W</button>
        </div>
        <div class="asset-toggles">
            <button class="asset-btn active" data-asset="SPY" onclick="toggleAsset('SPY')">SPY</button>
            <button class="asset-btn" data-asset="QQQ" onclick="toggleAsset('QQQ')">QQQ</button>
            <button class="asset-btn" data-asset="IGV" onclick="toggleAsset('IGV')">IGV</button>
            <button class="asset-btn" data-asset="GLD" onclick="toggleAsset('GLD')">GLD</button>
            <button class="asset-btn" data-asset="DXY" onclick="toggleAsset('DXY')">DXY</button>
        </div>
    </nav>

    <div class="corr-stats" id="corr-stats"></div>

    <!-- BTC Price Chart (Chart.js) -->
    <section class="chart-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">BTC/USD</h2>
                <span class="section-subtitle" id="btc-chart-subtitle">Weekly Close · All Time</span>
            </div>
            <div class="tabs">
                <button class="tab-btn" data-btc-range="1y" onclick="setBtcRange('1y')">1Y</button>
                <button class="tab-btn" data-btc-range="3y" onclick="setBtcRange('3y')">3Y</button>
                <button class="tab-btn active" data-btc-range="all" onclick="setBtcRange('all')">ALL</button>
            </div>
        </div>
        <div class="watermark">HERDVIBE</div>
        <div class="btc-chart-wrapper" id="btc-chart-wrapper">
            <canvas id="btc-chart"></canvas>
        </div>
    </section>

    <!-- Correlation Chart -->
    <section class="chart-section">
        <div class="section-header">
            <div>
                <h2 class="section-title" id="corr-title">26주 롤링 상관관계</h2>
                <span class="section-subtitle">비트코인과의 피어슨 상관계수</span>
            </div>
        </div>
        <div class="watermark" style="font-size:36px;">HERDVIBE</div>
        <div class="corr-chart-box">
            <canvas id="correlation-chart"></canvas>
        </div>
    </section>

    <footer class="footer">
        <div class="share-buttons">
            <a class="share-btn" id="share-x" href="#" target="_blank">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                트위터
            </a>
            <button class="share-btn" id="share-kakao" onclick="shareKakao()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-5.523 0-10 3.582-10 8 0 2.868 1.893 5.382 4.736 6.806-.152.56-.874 3.226-.899 3.424 0 0-.019.154.073.213.092.06.2.027.2.027.264-.037 3.063-1.998 3.545-2.34.77.112 1.565.17 2.345.17 5.523 0 10-3.582 10-8s-4.477-8-10-8z"/></svg>
                카카오톡
            </button>
            <a class="share-btn" id="share-telegram" href="#" target="_blank">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                텔레그램
            </a>
            <button class="share-btn" onclick="shareInstagram()">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/></svg>
                인스타그램
            </button>
            <button class="share-btn" onclick="copyLink()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                링크복사
            </button>
        </div>
        <div class="footer-info">
            Last updated: <span id="footer-date">--</span> · Weekly Rolling Correlation
        </div>
    </footer>
</div>

<script>
// ===== State =====
var DATA = null;
var currentPeriod = 26;
var currentBtcRange = 'all';
var activeAssets = new Set(['SPY']);
var btcChart = null;
var correlationChart = null;

var ASSET_COLORS = {
  SPY: { line: '#4dabf7', bg: 'rgba(77,171,247,0.08)' },
  QQQ: { line: '#b197fc', bg: 'rgba(177,151,252,0.08)' },
  IGV: { line: '#00d4aa', bg: 'rgba(0,212,170,0.08)' },
  GLD: { line: '#ffd43b', bg: 'rgba(255,212,59,0.08)' },
  DXY: { line: '#ff4757', bg: 'rgba(255,71,87,0.08)' },
};
var ASSET_LABELS = {
  SPY: 'S&P 500', QQQ: 'NASDAQ 100', IGV: 'Software', GLD: 'Gold', DXY: 'US Dollar',
};

function formatCurrency(v) {
  if (v == null) return '--';
  if (v >= 1000) return '$' + (v / 1000).toFixed(0) + 'k';
  if (v >= 1) return '$' + v.toFixed(0);
  return '$' + v.toFixed(2);
}

// ===== Load Data =====
async function loadData() {
  try {
    var resp = await fetch('data.json?v=' + Date.now());
    DATA = await resp.json();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<div style="color:#ff4757;font-size:0.85rem;">데이터 로드 실패</div>';
    return;
  }
  document.getElementById('btc-price-value').textContent =
    Number(DATA.btcLatest).toLocaleString('en-US', { maximumFractionDigits: 0 });
  document.getElementById('last-updated').textContent = DATA.lastUpdated;
  document.getElementById('footer-date').textContent = DATA.lastUpdated;

  initBtcChart();
  initCorrelationChart();
  updateCorrelationStats();
  setupShareLinks();
  connectBinance();
  setTimeout(function() { document.getElementById('loading').classList.add('hidden'); }, 300);
}

// ===== BTC Price Chart (Chart.js) =====
function sliceBtcData(range) {
  var candles = DATA.candles.filter(function(c) { return c.c != null; });
  if (range === 'all') return candles;
  var years = range === '1y' ? 1 : 3;
  var lastDate = new Date(candles[candles.length - 1].t);
  var cutoff = new Date(lastDate);
  cutoff.setFullYear(cutoff.getFullYear() - years);
  var cutoffStr = cutoff.toISOString().split('T')[0];
  return candles.filter(function(c) { return c.t >= cutoffStr; });
}

function initBtcChart() {
  var candles = sliceBtcData(currentBtcRange);
  var dates = candles.map(function(c) { return new Date(c.t + 'T00:00:00'); });
  var prices = candles.map(function(c) { return c.c; });

  var timeUnit = 'year';
  var maxTicks = 14;
  if (currentBtcRange === '1y') { timeUnit = 'month'; maxTicks = 12; }
  else if (currentBtcRange === '3y') { timeUnit = 'quarter'; maxTicks = 10; }

  var xMax = new Date(dates[dates.length - 1]);
  xMax.setDate(xMax.getDate() + 14);

  var wrapper = document.getElementById('btc-chart-wrapper');
  wrapper.innerHTML = '<canvas id="btc-chart"></canvas>';
  var ctx = document.getElementById('btc-chart').getContext('2d');

  btcChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'BTC Price',
        data: prices,
        borderColor: '#a1a1aa',
        backgroundColor: function(context) {
          var c = context.chart;
          if (!c.chartArea) return 'rgba(161,161,170,0.05)';
          var g = c.ctx.createLinearGradient(0, c.chartArea.top, 0, c.chartArea.bottom);
          g.addColorStop(0, 'rgba(161,161,170,0.12)');
          g.addColorStop(1, 'rgba(161,161,170,0.01)');
          return g;
        },
        fill: true,
        borderWidth: 2,
        tension: 0.15,
        pointRadius: 0,
        pointHoverRadius: 4,
        pointHoverBackgroundColor: '#a1a1aa',
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 400 },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a1a1a',
          borderColor: '#333',
          borderWidth: 1,
          titleColor: '#e4e4e7',
          bodyColor: '#a1a1aa',
          padding: 12,
          titleFont: { family: "'JetBrains Mono', monospace" },
          bodyFont: { family: "'JetBrains Mono', monospace" },
          callbacks: {
            title: function(ctx) {
              var d = new Date(ctx[0].parsed.x);
              return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            },
            label: function(ctx) {
              return 'BTC: $' + Number(ctx.raw).toLocaleString('en-US', { maximumFractionDigits: 0 });
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          min: dates[0],
          max: xMax,
          time: { unit: timeUnit, displayFormats: { month: 'MMM yyyy', quarter: 'MMM yyyy', year: 'yyyy' } },
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: {
            color: '#555',
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            maxTicksLimit: maxTicks
          },
          border: { color: 'rgba(255,255,255,0.06)' }
        },
        y: {
          position: 'right',
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: {
            color: '#555',
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            callback: function(v) { return formatCurrency(v); }
          },
          border: { color: 'rgba(255,255,255,0.06)' }
        }
      }
    }
  });
}

function setBtcRange(range) {
  currentBtcRange = range;
  document.querySelectorAll('[data-btc-range]').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-btc-range') === range);
  });
  var labels = { '1y': '1 Year', '3y': '3 Year', 'all': 'All Time' };
  document.getElementById('btc-chart-subtitle').textContent = 'Weekly Close · ' + labels[range];
  if (btcChart) { btcChart.destroy(); btcChart = null; }
  initBtcChart();
}

// ===== Correlation Chart =====
function initCorrelationChart() {
  var ctx = document.getElementById('correlation-chart').getContext('2d');
  correlationChart = new Chart(ctx, {
    type: 'line',
    data: { datasets: [] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(10,10,10,0.95)',
          titleColor: '#fff', bodyColor: '#ccc',
          borderColor: '#333', borderWidth: 1,
          titleFont: { family: "'JetBrains Mono', monospace", size: 11 },
          bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
          padding: 12, cornerRadius: 8,
          callbacks: {
            label: function(ctx) {
              var val = ctx.parsed.y;
              if (val == null) return null;
              var sign = val >= 0 ? '+' : '';
              return '  ' + ctx.dataset.label + ': ' + sign + val.toFixed(3);
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'year', displayFormats: { year: 'yyyy' } },
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: { font: { family: "'JetBrains Mono', monospace", size: 10 }, color: '#555', maxTicksLimit: 12 },
          border: { color: 'rgba(255,255,255,0.06)' }
        },
        y: {
          position: 'right', min: -1, max: 1,
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: {
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            color: '#555', stepSize: 0.25,
            callback: function(v) { return v.toFixed(2); }
          },
          border: { color: 'rgba(255,255,255,0.06)' }
        }
      },
      elements: {
        point: { radius: 0, hoverRadius: 4 },
        line: { borderWidth: 2 }
      }
    },
    plugins: [
      {
        id: 'zeroLine',
        beforeDraw: function(chart) {
          var ctx = chart.ctx, area = chart.chartArea, scales = chart.scales;
          if (!area) return;
          var y0 = scales.y.getPixelForValue(0);
          ctx.save();
          ctx.strokeStyle = 'rgba(255,255,255,0.12)';
          ctx.lineWidth = 1.5;
          ctx.setLineDash([6, 4]);
          ctx.beginPath();
          ctx.moveTo(area.left, y0);
          ctx.lineTo(area.right, y0);
          ctx.stroke();
          ctx.restore();
        }
      },
      {
        id: 'extremeZones',
        beforeDraw: function(chart) {
          var ctx = chart.ctx, area = chart.chartArea, scales = chart.scales;
          if (!area) return;
          ctx.save();
          ctx.fillStyle = 'rgba(0,212,170,0.04)';
          ctx.fillRect(area.left, scales.y.getPixelForValue(1), area.width,
            scales.y.getPixelForValue(0.75) - scales.y.getPixelForValue(1));
          ctx.fillStyle = 'rgba(255,71,87,0.04)';
          ctx.fillRect(area.left, scales.y.getPixelForValue(-0.75), area.width,
            scales.y.getPixelForValue(-1) - scales.y.getPixelForValue(-0.75));
          ctx.restore();
        }
      }
    ]
  });
  updateCorrelationData();
}

function updateCorrelationData() {
  if (!DATA || !correlationChart) return;
  var corrData = DATA.correlations[String(currentPeriod)];
  if (!corrData) return;
  var datasets = [];
  ['SPY','QQQ','IGV','GLD','DXY'].forEach(function(asset) {
    if (!activeAssets.has(asset)) return;
    var points = corrData
      .filter(function(d) { return d[asset] != null; })
      .map(function(d) { return { x: d.t, y: d[asset] }; });
    datasets.push({
      label: asset + ' (' + ASSET_LABELS[asset] + ')',
      data: points,
      borderColor: ASSET_COLORS[asset].line,
      backgroundColor: ASSET_COLORS[asset].bg,
      fill: false, tension: 0.3, borderWidth: 2
    });
  });
  correlationChart.data.datasets = datasets;
  correlationChart.update('none');
  document.getElementById('corr-title').textContent = currentPeriod + '주 롤링 상관관계';
}

function updateCorrelationStats() {
  if (!DATA) return;
  var corrData = DATA.correlations[String(currentPeriod)];
  if (!corrData) return;
  var latest = corrData[corrData.length - 1];
  var container = document.getElementById('corr-stats');
  container.innerHTML = '';
  ['SPY','QQQ','IGV','GLD','DXY'].forEach(function(asset) {
    if (!activeAssets.has(asset)) return;
    var val = latest[asset];
    if (val == null) return;
    var cls = val > 0.1 ? 'corr-positive' : val < -0.1 ? 'corr-negative' : 'corr-neutral';
    var sign = val >= 0 ? '+' : '';
    var item = document.createElement('div');
    item.className = 'corr-stat-item';
    item.innerHTML = '<div class="corr-stat-dot" style="background:' + ASSET_COLORS[asset].line + '"></div>' +
      '<span class="corr-stat-name">' + asset + '</span>' +
      '<span class="corr-stat-value ' + cls + '">' + sign + val.toFixed(3) + '</span>';
    container.appendChild(item);
  });
}

// ===== Controls =====
function setPeriod(p) {
  currentPeriod = p;
  document.querySelectorAll('[data-period]').forEach(function(btn) {
    btn.classList.toggle('active', parseInt(btn.dataset.period) === p);
  });
  updateCorrelationData();
  updateCorrelationStats();
}

function toggleAsset(asset) {
  var btn = document.querySelector('[data-asset="' + asset + '"]');
  if (activeAssets.has(asset)) { activeAssets.delete(asset); btn.classList.remove('active'); }
  else { activeAssets.add(asset); btn.classList.add('active'); }
  updateCorrelationData();
  updateCorrelationStats();
}

// ===== Binance WebSocket =====
var _ws = null, _wsRetry = 0;
function connectBinance() {
  try {
    _ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
    _ws.onopen = function() { _wsRetry = 0; };
    _ws.onmessage = function(e) {
      try {
        var d = JSON.parse(e.data);
        var price = parseFloat(d.p);
        document.getElementById('btc-price-value').innerHTML =
          Number(price).toLocaleString('en-US', { maximumFractionDigits: 0 }) +
          '<span class="live-dot"></span>';
      } catch(ex) {}
    };
    _ws.onclose = function() {
      if (_wsRetry < 10) setTimeout(connectBinance, Math.min(3000 * Math.pow(1.5, _wsRetry++), 30000));
    };
    _ws.onerror = function() { _ws.close(); };
  } catch(e) {}
}

// ===== Share =====
var SHARE_URL = 'https://herdvibe.com/84';
var SHARE_TITLE = '비트코인 자산 상관관계 대시보드';

function setupShareLinks() {
  var text = encodeURIComponent('\u20bf ' + SHARE_TITLE + '\n\nBTC: $' + Number(DATA.btcLatest).toLocaleString() + '\n\n' + SHARE_URL);
  var url = encodeURIComponent(SHARE_URL);
  document.getElementById('share-x').href = 'https://twitter.com/intent/tweet?text=' + text;
  document.getElementById('share-telegram').href = 'https://t.me/share/url?url=' + url + '&text=' + encodeURIComponent('\u20bf ' + SHARE_TITLE + '\nBTC: $' + Number(DATA.btcLatest).toLocaleString());
  if (window.Kakao && !Kakao.isInitialized()) Kakao.init('a43ed7b39fac35458f4f9df925a279b5');
}

function shareKakao() {
  if (!window.Kakao || !Kakao.isInitialized()) return;
  Kakao.Share.sendDefault({
    objectType: 'feed',
    content: {
      title: SHARE_TITLE,
      description: 'BTC: $' + Number(DATA.btcLatest).toLocaleString() + ' \u00b7 SPY/QQQ/IGV/GLD/DXY',
      imageUrl: 'https://herdvibe.com/og-image.png',
      link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL }
    },
    buttons: [{ title: '대시보드 보기', link: { mobileWebUrl: SHARE_URL, webUrl: SHARE_URL } }]
  });
}

function _clipCopy(t){if(window.parent!==window){window.parent.postMessage({type:'copy',text:t},'*')}if(navigator.clipboard&&navigator.clipboard.writeText&&window.isSecureContext){navigator.clipboard.writeText(t).catch(function(){_fbCopy(t)})}else{_fbCopy(t)}}function _fbCopy(t){var a=document.createElement('textarea');a.value=t;a.style.cssText='position:fixed;left:-9999px;top:-9999px;opacity:0';document.body.appendChild(a);a.focus();a.select();try{document.execCommand('copy')}catch(e){}document.body.removeChild(a)}

function shareInstagram() {
  _clipCopy(SHARE_URL);
  alert('링크가 복사되었습니다. 인스타그램에 붙여넣기 해주세요!');
}

function copyLink() {
  _clipCopy(SHARE_URL);
  var btn = event.currentTarget;
  var orig = btn.innerHTML;
  btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#00d4aa" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 복사완료';
  btn.style.borderColor = '#00d4aa'; btn.style.color = '#00d4aa';
  setTimeout(function() { btn.innerHTML = orig; btn.style.borderColor = ''; btn.style.color = ''; }, 2000);
}

// ===== Init =====
loadData();
</script>
<script>
function sendHeight(){var h=document.documentElement.scrollHeight;window.parent.postMessage({id:'hvBtcCorrelation',height:h},'*')}
window.addEventListener('load',function(){sendHeight();setTimeout(sendHeight,500);setTimeout(sendHeight,1500)});
window.addEventListener('resize',sendHeight);
new MutationObserver(sendHeight).observe(document.body,{childList:true,subtree:true,attributes:true});
</script>
</body>
</html>
